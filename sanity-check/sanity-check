#!/bin/bash

############################################################
# GRIDBASE SANITY CHECK
# Includes:
#  - dependency installer
#  - interactive Gmail app-password setup
#  - msmtp configuration
#  - internet / port / service checks
#  - cloudflared status
#  - logging
############################################################

# -----------------------------
# COLORS
# -----------------------------
GREEN="\e[32m"; RED="\e[31m"; YELLOW="\e[33m"; BLUE="\e[34m"; NC="\e[0m"

TIMESTAMP=$(date)
HOST=$(hostname)
PUBLIC_IP=$(curl -s https://ifconfig.me || echo "Unavailable")
LOCAL_IPS=$(hostname -I)

LOGFILE="/var/log/sanity-check.log"
TMPFILE=$(mktemp)

echo "==============================================" | tee "$TMPFILE"
echo "         GRIDBASE SANITY CHECK" | tee -a "$TMPFILE"
echo "==============================================" | tee -a "$TMPFILE"
echo "Timestamp: $TIMESTAMP" | tee -a "$TMPFILE"
echo "Host: $HOST" | tee -a "$TMPFILE"
echo "Public IP: $PUBLIC_IP" | tee -a "$TMPFILE"
echo "Local IPs: $LOCAL_IPS" | tee -a "$TMPFILE"
echo "==============================================" | tee -a "$TMPFILE"
echo "" | tee -a "$TMPFILE"


############################################################
#                 DEPENDENCY CHECK + INSTALL
############################################################
echo -e "${BLUE}[DEPENDENCY CHECK]${NC}"
REQUIRED_PACKAGES=("msmtp" "msmtp-mta" "mailutils" "ca-certificates")

for pkg in "${REQUIRED_PACKAGES[@]}"; do
    if ! dpkg -s "$pkg" &>/dev/null; then
        echo -e "${YELLOW}Installing missing dependency: $pkg${NC}"
        sudo apt update -y && sudo apt install -y "$pkg"
    else
        echo -e "${GREEN}OK${NC}  $pkg installed"
    fi
done

sudo touch /var/log/msmtp.log
sudo chmod 666 /var/log/msmtp.log

echo ""


############################################################
#       EMAIL CONFIGURATION — FIRST RUN INTERACTIVE SETUP
############################################################
if [[ ! -f /etc/msmtprc ]]; then

    echo "============================================================"
    echo "EMAIL SETUP REQUIRED"
    echo "============================================================"
    echo ""
    echo "This script can send system health reports by email."
    echo ""
    echo "IMPORTANT:"
    echo "  Gmail DOES NOT allow normal passwords."
    echo "  You MUST create a Gmail App Password."
    echo ""
    echo "STEPS:"
    echo "  1. Visit: https://myaccount.google.com/security"
    echo "  2. Enable 2-Step Verification"
    echo "  3. Go to 'App Passwords'"
    echo "  4. Create password for: Mail → Linux"
    echo "  5. Copy the 16-character password"
    echo ""

    read -p "Would you like to configure email now? (y/n): " EMAILSETUP

    if [[ "$EMAILSETUP" =~ ^[Yy]$ ]]; then
        read -p "Enter your Gmail address: " GMAIL_USER
        echo -n "Enter your Gmail App Password: "
        read -s GMAIL_PASS
        echo ""

        # Write configuration
        sudo bash -c "cat >/etc/msmtprc" <<EOF
defaults
auth           on
tls            on
tls_trust_file /etc/ssl/certs/ca-certificates.crt
logfile        /var/log/msmtp.log

account gridbase
host smtp.gmail.com
port 587
from $GMAIL_USER
user $GMAIL_USER
password $GMAIL_PASS

account default : gridbase
EOF

        sudo chmod 600 /etc/msmtprc

        echo -e "${GREEN}Email successfully configured!${NC}"
        echo ""

    else
        echo -e "${YELLOW}[WARNING] Email alerts DISABLED — msmtp not configured.${NC}"
        EMAIL_DISABLED=1
        echo ""
    fi

else
    echo -e "${GREEN}Email configuration found at /etc/msmtprc${NC}"
    echo ""
fi


############################################################
# INTERNET CHECK
############################################################
echo -e "${BLUE}[INTERNET CONNECTIVITY]${NC}"

if ping -c1 8.8.8.8 &>/dev/null; then
    echo -e "${GREEN}Internet: ONLINE${NC}" | tee -a "$TMPFILE"
else
    echo -e "${RED}Internet: OFFLINE${NC}" | tee -a "$TMPFILE"
fi
echo ""


############################################################
# CLOUDFLARE TUNNEL STATUS
############################################################
echo -e "${BLUE}[CLOUDFLARE TUNNEL]${NC}"
if systemctl is-active --quiet cloudflared; then
    echo -e "${GREEN}cloudflared: RUNNING${NC}" | tee -a "$TMPFILE"
else
    echo -e "${RED}cloudflared: NOT RUNNING${NC}" | tee -a "$TMPFILE"
fi
echo ""


############################################################
# RUNNING SERVICES
############################################################
echo -e "${BLUE}[RUNNING SYSTEMD SERVICES]${NC}"
systemctl list-units --type=service --state=running --no-legend | awk '{print $1}' | while read svc; do
    echo -e "${GREEN}OK${NC}  $svc" | tee -a "$TMPFILE"
done
echo ""


############################################################
# FAILED SERVICES
############################################################
echo -e "${BLUE}[FAILED SYSTEMD UNITS]${NC}"

FAILED=$(systemctl --failed --type=service --no-legend)

if [[ -z "$FAILED" ]]; then
    echo -e "${GREEN}No failed units.${NC}" | tee -a "$TMPFILE"
else
    echo -e "${RED}FAILED UNITS DETECTED:${NC}" | tee -a "$TMPFILE"
    echo "$FAILED" | tee -a "$TMPFILE"
fi
echo ""


############################################################
# PORT SCAN - AUTO-DETECTED
############################################################
echo -e "${BLUE}[LISTENING PORTS]${NC}"

ss -tulpn \
    | grep LISTEN \
    | awk '{print $5}' \
    | sed 's/.*://g' \
    | sort -n \
    | uniq \
    | while read port; do
        echo -e "${GREEN}Port $port: OPEN${NC}" | tee -a "$TMPFILE"
done

echo ""


############################################################
# LOGGING
############################################################
echo "Sanity check complete." | tee -a "$TMPFILE"
echo "Report saved to: $TMPFILE"
echo "Persistent log stored at: $LOGFILE"

cat "$TMPFILE" >> "$LOGFILE"

exit 0
